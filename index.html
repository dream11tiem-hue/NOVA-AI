<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI Chat</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gemini: {
                            light: '#f0f4f9',
                            dark: '#131314',
                            sidebarLight: '#e9eef6',
                            sidebarDark: '#1e1f20',
                            accent: '#1a73e8'
                        }
                    }
                }
            }
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Base typography and scrollbar styles */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(107, 114, 128, 0.8); }

        /* Markdown Prose Styling */
        .markdown-body { font-size: 1rem; line-height: 1.6; }
        .markdown-body p { margin-bottom: 1em; }
        .markdown-body pre { background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-bottom: 1em; }
        .light .markdown-body pre { background: #f3f4f6; color: #1f2937; }
        .markdown-body code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; background: rgba(128,128,128,0.2); padding: 0.1em 0.3em; border-radius: 0.2rem; }
        .markdown-body pre code { background: none; padding: 0; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body a { color: #3b82f6; text-decoration: underline; }

        /* Mobile Sidebar Overlay */
        #sidebar-overlay { display: none; }
        #sidebar-overlay.active { display: block; }
        
        /* Blinking Cursor for AI */
        .typing-cursor::after {
            content: 'â–‹';
            display: inline-block;
            animation: blink 1s step-end infinite;
            margin-left: 2px;
            color: #3b82f6;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-white text-gray-900 dark:bg-gemini-dark dark:text-gray-100 flex flex-col min-h-screen transition-colors duration-200">

    <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-white dark:bg-gemini-dark text-xl font-semibold transition-opacity duration-300">
        <div class="flex flex-col items-center gap-4">
            <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span>Loading App...</span>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden h-full relative">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-20 md:hidden" onclick="toggleSidebar()"></div>

        <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-72 bg-gemini-sidebarLight dark:bg-gemini-sidebarDark transform -translate-x-full md:translate-x-0 md:relative md:flex flex-col transition-transform duration-300 ease-in-out">
            <div class="p-4 flex items-center justify-between">
                <button onclick="createNewChat()" class="flex-1 flex items-center gap-2 bg-white dark:bg-[#282a2c] hover:bg-gray-50 dark:hover:bg-gray-700 px-4 py-3 rounded-full shadow-sm transition-colors font-medium">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    New Chat
                </button>
                <button onclick="toggleSidebar()" class="md:hidden ml-2 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-2" id="chat-history-list">
                </div>

            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex flex-col gap-2">
                <button onclick="toggleTheme()" class="flex items-center gap-3 w-full p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-left text-sm font-medium">
                    <svg id="theme-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <span id="theme-text">Dark Mode</span>
                </button>
                <button onclick="openSettings()" class="flex items-center gap-3 w-full p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-left text-sm font-medium">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Settings
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 h-full relative bg-white dark:bg-gemini-dark">
            <header class="h-16 flex items-center justify-between px-4 sticky top-0 bg-white/80 dark:bg-gemini-dark/80 backdrop-blur-md z-10 border-b border-gray-100 dark:border-gray-800">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="md:hidden p-2 -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 class="font-semibold text-lg" id="current-chat-title">New Chat</h1>
                </div>
                <div class="text-sm text-gray-500" id="current-model-display"></div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto px-4 py-6 md:px-8 lg:px-24 flex flex-col gap-6 scroll-smooth">
                <div id="welcome-screen" class="flex-1 flex flex-col items-center justify-center text-center max-w-2xl mx-auto opacity-70">
                    <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-2xl flex items-center justify-center mb-6">
                        <svg class="w-8 h-8 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <h2 class="text-2xl font-semibold mb-2">How can I help you today?</h2>
                    <p class="text-gray-500 dark:text-gray-400">Enter a prompt below to start communicating with the AI. Configure your OpenRouter API key in settings first.</p>
                </div>
            </div>

            <div class="p-4 md:px-8 lg:px-24 bg-white dark:bg-gemini-dark border-t border-gray-100 dark:border-gray-800">
                <div class="max-w-4xl mx-auto relative rounded-3xl bg-gray-100 dark:bg-[#1e1f20] border border-gray-200 dark:border-gray-700 focus-within:ring-1 focus-within:ring-blue-500 dark:focus-within:ring-gray-500 transition-all flex items-end overflow-hidden">
                    <textarea 
                        id="user-input" 
                        rows="1" 
                        class="w-full max-h-48 py-4 pl-6 pr-14 bg-transparent resize-none outline-none text-gray-900 dark:text-gray-100 placeholder-gray-500 rounded-3xl"
                        placeholder="Message AI..."
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px';"
                    ></textarea>
                    <button id="send-btn" onclick="sendMessage()" class="absolute right-3 bottom-3 p-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
                <div class="text-xs text-center text-gray-400 mt-2">AI can make mistakes. Check important info.</div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-[#1e1f20] rounded-2xl w-full max-w-md p-6 shadow-2xl transform transition-all">
            <h2 class="text-xl font-bold mb-4">Settings</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">OpenRouter API Key</label>
                    <input type="password" id="api-key-input" class="w-full px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="sk-or-v1-...">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Model ID</label>
                    <input type="text" id="model-input" class="w-full px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="deepseek/deepseek-r1:free">
                    <p class="text-xs text-gray-500 mt-1">Default: deepseek/deepseek-r1:free</p>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">System Prompt</label>
                    <textarea id="system-prompt-input" rows="3" class="w-full px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" placeholder="You are a helpful assistant..."></textarea>
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closeSettings()" class="px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 font-medium">Cancel</button>
                <button onclick="saveSettings()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // STATE MANAGEMENT
        // ==========================================
        const STATE_KEY = 'universal_ai_chat_data';
        let state = {
            apiKey: '',
            model: 'deepseek/deepseek-r1:free',
            systemPrompt: 'You are a helpful and concise AI assistant.',
            isDarkMode: true,
            chats: [], // { id, title, messages: [] }
            currentChatId: null
        };

        let isGenerating = false;
        let abortController = null;

        // ==========================================
        // INITIALIZATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            applyTheme();
            renderChatHistoryList();
            
            if (state.chats.length === 0) {
                createNewChat(false);
            } else {
                selectChat(state.currentChatId || state.chats[0].id);
            }

            setupEventListeners();
            
            // Hide Loader securely after initialization
            setTimeout(() => {
                const loader = document.getElementById('loading');
                if(loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.remove(), 300);
                }
            }, 100);
        });

        // ==========================================
        // DATA PERSISTENCE
        // ==========================================
        function loadState() {
            try {
                const saved = localStorage.getItem(STATE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                }
            } catch (e) {
                console.error("Failed to load state", e);
            }
        }

        function saveState() {
            try {
                localStorage.setItem(STATE_KEY, JSON.stringify(state));
            } catch (e) {
                console.error("Failed to save state", e);
            }
        }

        // ==========================================
        // UI INTERACTIONS
        // ==========================================
        function setupEventListeners() {
            const input = document.getElementById('user-input');
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('active');
        }

        function toggleTheme() {
            state.isDarkMode = !state.isDarkMode;
            applyTheme();
            saveState();
        }

        function applyTheme() {
            const html = document.documentElement;
            const themeText = document.getElementById('theme-text');
            const themeIcon = document.getElementById('theme-icon');
            
            if (state.isDarkMode) {
                html.classList.add('dark');
                html.classList.remove('light');
                if(themeText) themeText.innerText = 'Light Mode';
                if(themeIcon) themeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>`;
            } else {
                html.classList.add('light');
                html.classList.remove('dark');
                if(themeText) themeText.innerText = 'Dark Mode';
                if(themeIcon) themeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>`;
            }
        }

        function openSettings() {
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('model-input').value = state.model || 'deepseek/deepseek-r1:free';
            document.getElementById('system-prompt-input').value = state.systemPrompt;
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            state.apiKey = document.getElementById('api-key-input').value.trim();
            state.model = document.getElementById('model-input').value.trim() || 'deepseek/deepseek-r1:free';
            state.systemPrompt = document.getElementById('system-prompt-input').value.trim();
            saveState();
            closeSettings();
            document.getElementById('current-model-display').innerText = state.model.split('/').pop();
        }

        // ==========================================
        // CHAT MANAGEMENT
        // ==========================================
        function createNewChat(triggerSave = true) {
            if (isGenerating) return;
            
            const newChat = {
                id: Date.now().toString(),
                title: 'New Chat',
                messages: []
            };
            
            state.chats.unshift(newChat);
            if(triggerSave) saveState();
            selectChat(newChat.id);
            renderChatHistoryList();
            
            // Close sidebar on mobile
            if(window.innerWidth < 768) toggleSidebar();
        }

        function selectChat(id) {
            if (isGenerating) return;
            
            state.currentChatId = id;
            saveState();
            renderChatHistoryList();
            renderCurrentChat();
            
            document.getElementById('current-model-display').innerText = state.model.split('/').pop() || 'Model';
        }

        function deleteChat(id, event) {
            event.stopPropagation();
            if (isGenerating) return;
            
            if(confirm("Delete this chat?")) {
                state.chats = state.chats.filter(c => c.id !== id);
                if (state.currentChatId === id) {
                    state.currentChatId = state.chats.length > 0 ? state.chats[0].id : null;
                }
                if (state.chats.length === 0) createNewChat(false);
                saveState();
                renderChatHistoryList();
                if(state.currentChatId) selectChat(state.currentChatId);
            }
        }

        function renameChat(id, event) {
            event.stopPropagation();
            if (isGenerating) return;
            
            const chat = state.chats.find(c => c.id === id);
            const newTitle = prompt("Rename chat:", chat.title);
            if (newTitle && newTitle.trim() !== "") {
                chat.title = newTitle.trim();
                saveState();
                renderChatHistoryList();
                if(state.currentChatId === id) {
                    document.getElementById('current-chat-title').innerText = chat.title;
                }
            }
        }

        function renderChatHistoryList() {
            const container = document.getElementById('chat-history-list');
            container.innerHTML = '';
            
            state.chats.forEach(chat => {
                const isActive = chat.id === state.currentChatId;
                const div = document.createElement('div');
                div.className = `group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-colors ${isActive ? 'bg-blue-100/50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 font-medium' : 'hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300'}`;
                div.onclick = () => selectChat(chat.id);
                
                div.innerHTML = `
                    <div class="truncate flex-1 pr-2 text-sm">${escapeHTML(chat.title)}</div>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="renameChat('${chat.id}', event)" class="p-1 hover:text-blue-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                        <button onclick="deleteChat('${chat.id}', event)" class="p-1 hover:text-red-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderCurrentChat() {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            const container = document.getElementById('chat-container');
            const titleElem = document.getElementById('current-chat-title');
            
            if(!chat) return;
            
            titleElem.innerText = chat.title;
            container.innerHTML = '';
            
            if (chat.messages.length === 0) {
                container.innerHTML = `
                <div id="welcome-screen" class="flex-1 flex flex-col items-center justify-center text-center max-w-2xl mx-auto opacity-70 mt-20">
                    <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-2xl flex items-center justify-center mb-6 shadow-inner">
                        <svg class="w-8 h-8 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <h2 class="text-2xl font-semibold mb-2">How can I help you today?</h2>
                    <p class="text-gray-500 dark:text-gray-400">Model: ${state.model.split('/').pop()}</p>
                </div>`;
                return;
            }

            chat.messages.forEach(msg => appendMessageToDOM(msg.role, msg.content));
            scrollToBottom();
        }

        // ==========================================
        // MESSAGE RENDERING & STREAMING
        // ==========================================
        function appendMessageToDOM(role, content, isStreaming = false) {
            const container = document.getElementById('chat-container');
            const welcome = document.getElementById('welcome-screen');
            if (welcome) welcome.remove();

            const wrapper = document.createElement('div');
            wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} w-full`;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `max-w-3xl rounded-3xl px-6 py-4 shadow-sm ${
                role === 'user' 
                ? 'bg-blue-100 dark:bg-blue-900/40 text-gray-900 dark:text-gray-100 rounded-br-sm' 
                : 'bg-white dark:bg-[#1e1f20] border border-gray-100 dark:border-gray-800 text-gray-800 dark:text-gray-200 rounded-bl-sm markdown-body w-full'
            }`;

            if (role === 'user') {
                messageDiv.innerText = content; // Text only for user
            } else {
                messageDiv.innerHTML = marked.parse(content || '');
                if (isStreaming) messageDiv.classList.add('typing-cursor');
            }

            wrapper.appendChild(messageDiv);
            container.appendChild(wrapper);
            scrollToBottom();
            return messageDiv;
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            if (isGenerating) return;
            if (!state.apiKey) {
                alert("Please configure your OpenRouter API key in settings first.");
                openSettings();
                return;
            }

            const inputElem = document.getElementById('user-input');
            const content = inputElem.value.trim();
            if (!content) return;

            // Reset input UI
            inputElem.value = '';
            inputElem.style.height = 'auto';
            
            const chat = state.chats.find(c => c.id === state.currentChatId);
            
            // Auto-generate title for first message
            if (chat.messages.length === 0) {
                chat.title = content.length > 30 ? content.substring(0, 30) + '...' : content;
                document.getElementById('current-chat-title').innerText = chat.title;
                renderChatHistoryList();
            }

            // Save user message
            chat.messages.push({ role: 'user', content });
            saveState();
            appendMessageToDOM('user', content);

            // Prepare AI message
            isGenerating = true;
            document.getElementById('send-btn').disabled = true;
            const aiMessageDiv = appendMessageToDOM('assistant', '', true);
            let aiContent = "";

            try {
                abortController = new AbortController();
                const messagesPayload = [
                    { role: 'system', content: state.systemPrompt },
                    ...chat.messages.map(m => ({ role: m.role, content: m.content }))
                ];

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.apiKey}`
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: messagesPayload,
                        stream: true
                    }),
                    signal: abortController.signal
                });

                if (!response.ok) {
                    const errorTxt = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorTxt}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            if (dataStr.trim() === '[DONE]') continue;
                            
                            try {
                                const data = JSON.parse(dataStr);
                                const token = data.choices[0]?.delta?.content || "";
                                aiContent += token;
                                aiMessageDiv.innerHTML = marked.parse(aiContent);
                                scrollToBottom();
                            } catch (e) {
                                // Ignore partial parse errors in streams
                            }
                        }
                    }
                }

            } catch (error) {
                if (error.name !== 'AbortError') {
                    aiContent = `**Error:** ${error.message}`;
                    aiMessageDiv.innerHTML = marked.parse(aiContent);
                    console.error("Streaming Error:", error);
                }
            } finally {
                aiMessageDiv.classList.remove('typing-cursor');
                isGenerating = false;
                document.getElementById('send-btn').disabled = false;
                
                // Save complete interaction
                chat.messages.push({ role: 'assistant', content: aiContent });
                saveState();
            }
        }

        // ==========================================
        // UTILS
        // ==========================================
        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
    </script>
</body>
</html>

